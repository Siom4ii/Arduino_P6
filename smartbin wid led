#include <Servo.h>
#include <LiquidCrystal_I2C.h>

// -------- PIN DEFINITIONS --------
#define TRIG_FRONT 8    // Ultrasonic #1 (front for hand detection)
#define ECHO_FRONT 7

#define TRIG_TOP   4    // Ultrasonic #2 (inside bin for fill level)
#define ECHO_TOP   3

#define SERVO_PIN  9    // Servo for lid
#define BUZZER_PIN 6    // NORMAL buzzer (ON/OFF beep)

// LEDs
#define LED_LID    10   // Lid status LED
#define LED_GREEN  11   // Level: normal
#define LED_YELLOW 12   // Level: almost full
#define LED_RED    13   // Level: full (100%)

// -------- CONFIGURABLE CONSTANTS --------
#define OPEN_DISTANCE 20         // cm: distance to detect hand
#define LID_CLOSED_ANGLE 0       // adjust for your servo
#define LID_OPEN_ANGLE   90      // adjust for your servo
#define BIN_HEIGHT_CM    40      // cm: measure inside height of your trash bin

const unsigned long LID_DELAY         = 3000;  // ms lid stays open
const unsigned long HAND_REQUIRED_TIME = 800;  // ms hand must stay before opening

// -------- OBJECTS --------
Servo lidServo;
LiquidCrystal_I2C lcd(0x27, 16, 2);   // change to 0x3F if LCD is blank

// -------- GLOBAL VARIABLES --------
int distanceFront = 0;
int distanceTop   = 0;
int fillPercent   = 0;

bool lidOpen = false;
bool handStillThere = false;

unsigned long lidOpenTime    = 0;
unsigned long handDetectTime = 0;
unsigned long lastBeepTime   = 0;     // for buzzer pattern


// -------- HELPER FUNCTIONS --------

int getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);

  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 30000);
  if (duration == 0) return 999;

  return duration * 0.034 / 2;   // distance in cm
}

int computeFillPercent(int distTop) {
  if (distTop <= 0 || distTop > BIN_HEIGHT_CM + 20) return 0;
  if (distTop < 5) return 100;

  float filledHeight = BIN_HEIGHT_CM - distTop;
  float pct = (filledHeight / BIN_HEIGHT_CM) * 100.0;

  if (pct < 0) pct = 0;
  if (pct > 100) pct = 100;

  return (int)pct;
}


// -------- SETUP --------
void setup() {
  Serial.begin(9600);

  pinMode(TRIG_FRONT, OUTPUT);
  pinMode(ECHO_FRONT, INPUT);

  pinMode(TRIG_TOP, OUTPUT);
  pinMode(ECHO_TOP, INPUT);

  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);

  // LED pins
  pinMode(LED_LID, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(LED_YELLOW, OUTPUT);
  pinMode(LED_RED, OUTPUT);

  digitalWrite(LED_LID, LOW);
  digitalWrite(LED_GREEN, LOW);
  digitalWrite(LED_YELLOW, LOW);
  digitalWrite(LED_RED, LOW);

  lidServo.attach(SERVO_PIN);
  lidServo.write(LID_CLOSED_ANGLE);

  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.print("Smart Trash Bin");
  delay(2000);
  lcd.clear();
}


// -------- MAIN LOOP --------
void loop() {

  unsigned long currentTime = millis();

  // 1) Read sensors
  distanceFront = getDistance(TRIG_FRONT, ECHO_FRONT);
  distanceTop   = getDistance(TRIG_TOP, ECHO_TOP);
  fillPercent   = computeFillPercent(distanceTop);

  Serial.print("Front:");
  Serial.print(distanceFront);
  Serial.print(" | Top:");
  Serial.print(distanceTop);
  Serial.print(" | Fill:");
  Serial.print(fillPercent);
  Serial.println("%");


  // ----- SMART HAND-DETECTION WITH REQUIRED HOLD TIME -----
  bool handDetected = (distanceFront > 0 && distanceFront < OPEN_DISTANCE);

  if (handDetected && fillPercent < 100) {

    if (!handStillThere) {
      handStillThere = true;
      handDetectTime = currentTime;
      Serial.println("Hand detected, starting timer…");
    }

    if (handStillThere && (currentTime - handDetectTime >= HAND_REQUIRED_TIME)) {
      if (!lidOpen) {
        Serial.println("Hand stable → Opening lid");
        lidServo.write(LID_OPEN_ANGLE);
        lidOpen = true;
      }
      lidOpenTime = currentTime;
    }

  } else {
    handStillThere = false;
  }

  // ----- AUTO CLOSE AFTER TIME -----
  if (lidOpen && (currentTime - lidOpenTime >= LID_DELAY)) {
    Serial.println("Closing lid...");
    lidServo.write(LID_CLOSED_ANGLE);
    lidOpen = false;
  }


  // ----- BUZZER ALERT WHEN FULL -----
  if (fillPercent >= 100) {
    // Fast beep: toggle every 200 ms
    if ((currentTime - lastBeepTime) > 200) {
      digitalWrite(BUZZER_PIN, !digitalRead(BUZZER_PIN));
      lastBeepTime = currentTime;
    }
  } else {
    digitalWrite(BUZZER_PIN, LOW);
  }


  // ----- LED STATUS -----

  // Lid LED (ON when lid is open)
  digitalWrite(LED_LID, lidOpen ? HIGH : LOW);

  // Level LEDs
  if (fillPercent >= 100) {
    // FULL
    digitalWrite(LED_GREEN, LOW);
    digitalWrite(LED_YELLOW, LOW);
    digitalWrite(LED_RED, HIGH);
  }
  else if (fillPercent >= 80) {
    // ALMOST FULL
    digitalWrite(LED_GREEN, LOW);
    digitalWrite(LED_YELLOW, HIGH);
    digitalWrite(LED_RED, LOW);
  }
  else {
    // NORMAL
    digitalWrite(LED_GREEN, HIGH);
    digitalWrite(LED_YELLOW, LOW);
    digitalWrite(LED_RED, LOW);
  }


  // ----- LCD OUTPUT -----
  lcd.setCursor(0, 0);
  lcd.print("Level: ");
  if (fillPercent < 10) lcd.print("  ");
  else if (fillPercent < 100) lcd.print(" ");
  lcd.print(fillPercent);
  lcd.print("%   ");

  lcd.setCursor(0, 1);
  lcd.print("Lid: ");
  lcd.print(lidOpen ? "OPEN  " : "CLOSED");

  delay(120);
}
